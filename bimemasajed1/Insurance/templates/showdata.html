{% extends "base.html" %}
{% block title %}ثبت بیمه نامه{% endblock %}

{% block content %}
<div class="p-6 max-w-4xl mx-auto">
  <h1 class="text-2xl font-bold mb-6 text-center text-indigo-700">تمام اطلاعات شما</h1>

  <!-- تب‌ها -->
  <div class="mb-6 border-b border-gray-200">
    <ul class="flex flex-wrap -mb-px" id="tabs">
      <li class="mr-2">
        <button class="tab-button inline-block p-4 border-b-2 font-medium text-gray-600 border-transparent hover:text-indigo-700 active"
                data-tab="tab1">
          اطلاعات مسجد
        </button>
      </li>

      <li class="mr-2">
        <button class="tab-button inline-block p-4 border-b-2 font-medium text-gray-600 border-transparent hover:text-indigo-700"
                data-tab="tab2"
                {% if not is_endorsement %}disabled{% endif %}>
          پوشش‌ها
        </button>
      </li>
    </ul>
  </div>

  <!-- تب 1: اطلاعات مسجد -->
  <div id="tab1" class="tab-content">
    {% for section, items in data.items %}
      <div class="bg-white rounded-lg shadow p-4 mb-4">
        <h2 class="text-lg font-semibold text-indigo-600 mb-2">{{ section }}</h2>

        {% if items %}
          {% if items.items %}
            <ul class="space-y-1">
              {% for key, value in items.items %}
                <li>
                  <span class="font-medium text-gray-700">{{ key }}:</span>
                  <span class="text-gray-900">{{ value }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            {% for obj in items %}
              <div class="border border-gray-200 rounded p-2 mb-2">
                <ul class="space-y-1">
                  {% for key, value in obj.items %}
                    <li>
                      <span class="font-medium text-gray-700">{{ key }}:</span>
                      <span class="text-gray-900">{{ value }}</span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endfor %}
          {% endif %}
        {% else %}
          <p class="text-gray-500">اطلاعاتی موجود نیست</p>
        {% endif %}
      </div>
    {% endfor %}

    {% if not is_endorsement %}
    <div class="text-center mt-4">
      <button id="confirm-btn" class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
        اطلاعات مسجد مورد تائید است
      </button>
    </div>
    {% endif %}
  </div>

  <!-- تب 2: پوشش‌ها -->
  <div id="tab2" class="tab-content {% if not is_endorsement %}hidden{% endif %}">
    <div class="bg-white rounded-lg shadow p-4 space-y-4">
      <h2 class="text-lg font-semibold text-indigo-600 mb-4">پوشش‌ها و فرم بیمه</h2>

      <form method="POST">
        {% csrf_token %}
        {{ form.signup.as_hidden }}

        {% if coverage_instance and not is_endorsement %}
        <div class="mb-4 text-center">
          <p class="text-orange-600 font-medium">
            شما یک بیمه نامه فعال دارید. در صورت نیاز به تغییرات، درخواست الحاقیه ثبت کنید.
          </p>
          <a href="?endorsement=true"
             class="px-6 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
            درخواست الحاقیه
          </a>
        </div>

        {% else %}
        <fieldset class="border border-gray-200 p-4 rounded space-y-4">
          <legend class="font-medium text-gray-700 mb-2">پوشش‌ها</legend>

          <!-- حلقه روی تمام پوشش‌ها -->
          {% for key, value in detail.items %}
          <div class="flex justify-between items-center">
            <span>{{ key }}</span>
            <span class="font-medium text-green-600">{{ value|intcomma }} تومان</span>
          </div>
          {% endfor %}

          <!-- اگر نیاز باشه فرم‌های مربوط به پارامترها هم باقی بمونن -->
          {% if form.vahanele_motori %}
          <div id="params_vahanele_motori" class="ml-6 hidden">
            {{ form.tabareh_66_person.label_tag }} {{ form.tabareh_66_person }}<br>
            {{ form.tabareh_66_total.label_tag }} {{ form.tabareh_66_total }}
          </div>
          {% endif %}
          {% if form.mamooriat_kharej %}
          <div id="params_mamooriat_kharej" class="ml-6 hidden">
            {{ form.mamooriat_kharej_person.label_tag }} {{ form.mamooriat_kharej_person }}<br>
            {{ form.mamooriat_kharej_total.label_tag }} {{ form.mamooriat_kharej_total }}
          </div>
          {% endif %}
          {% if form.gharamat_roozane %}
          <div id="params_gharamat_roozane" class="ml-6 hidden">
            {{ form.gharamat_roozane_person.label_tag }} {{ form.gharamat_roozane_person }}<br>
            {{ form.gharamat_roozane_total.label_tag }} {{ form.gharamat_roozane_total }}
          </div>
          {% endif %}
          {% if form.hazine_kargoshay %}
          <div id="params_hazine_kargoshay" class="ml-6 hidden">
            {{ form.hazine_kargoshay_person.label_tag }} {{ form.hazine_kargoshay_person }}<br>
            {{ form.hazine_kargoshay_total.label_tag }} {{ form.hazine_kargoshay_total }}
          </div>
          {% endif %}
          {% if form.die_increase %}
          <div id="params_die_increase" class="ml-6 hidden">
            {{ form.die_increase_option.label_tag }} {{ form.die_increase_option }}
          </div>
          {% endif %}

        </fieldset>

        <div class="flex justify-between mt-6">
          <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            ثبت اطلاعات
          </button>
          <span class="font-bold text-indigo-700">
            جمع کل: {{ total|intcomma }} تومان
          </span>
        </div>

        {% endif %}
      </form>
    </div>
  </div>
</div>

<script>
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.tab;
      tabContents.forEach(c => c.classList.add('hidden'));
      tabButtons.forEach(b => b.classList.remove('border-indigo-600','text-indigo-700'));
      document.getElementById(target).classList.remove('hidden');
      btn.classList.add('border-indigo-600','text-indigo-700');
    });
  });

  const confirmBtn = document.getElementById("confirm-btn");
  if(confirmBtn){
    confirmBtn.addEventListener('click', () => {
      const t = document.querySelector('button[data-tab="tab2"]');
      if(t){
        t.disabled = false;
        t.click();
      }
    });
  }

  const paramFields = [
    "vahanele_motori",
    "mamooriat_kharej",
    "gharamat_roozane",
    "hazine_kargoshay",
    "die_increase"
  ];

  paramFields.forEach(name => {
    const checkbox = document.querySelector(`input[name="${name}"]`);
    const box = document.getElementById(`params_${name}`);
    if(checkbox && box){
      checkbox.addEventListener("change", () => {
        box.classList.toggle("hidden", !checkbox.checked);
      });
      checkbox.dispatchEvent(new Event("change"));
    }
  });

  const IS_ENDORSEMENT = {{ is_endorsement|yesno:"true,false" }};
  document.addEventListener("DOMContentLoaded", () => {
    if(IS_ENDORSEMENT){
      const tb = document.querySelector('button[data-tab="tab2"]');
      if(tb){
        tb.disabled = false;
        tb.click();
      }
    }
  });
</script>
{% endblock %}
